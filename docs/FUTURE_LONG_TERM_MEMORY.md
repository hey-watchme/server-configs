# é•·æœŸè¨˜æ†¶ã¨ã‚³ãƒ³ãƒ†ã‚¯ã‚¹ãƒˆä¿æŒã®å®Ÿè£…è¨ˆç”»

æœ€çµ‚æ›´æ–°: 2026-01-09
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ğŸ”œ **ä»Šå¾Œã®å®Ÿè£…èª²é¡Œ**

---

## ğŸ“‹ ç›®æ¬¡

1. [å•é¡Œã®èƒŒæ™¯](#å•é¡Œã®èƒŒæ™¯)
2. [ç¾çŠ¶ã®åˆ¶ç´„](#ç¾çŠ¶ã®åˆ¶ç´„)
3. [ç›®æŒ‡ã™ã¹ãç†æƒ³ã®å§¿](#ç›®æŒ‡ã™ã¹ãç†æƒ³ã®å§¿)
4. [ææ¡ˆã™ã‚‹è§£æ±ºç­–](#ææ¡ˆã™ã‚‹è§£æ±ºç­–)
5. [å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—](#å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—)
6. [æŠ€è¡“çš„è©³ç´°](#æŠ€è¡“çš„è©³ç´°)
7. [å‚è€ƒè³‡æ–™](#å‚è€ƒè³‡æ–™)

---

## å•é¡Œã®èƒŒæ™¯

### ç¾åœ¨ã®Spotåˆ†æã®é™ç•Œ

WatchMeã¯ç¾åœ¨ã€ä»¥ä¸‹ã®3éšå±¤ã§æ„Ÿæƒ…åˆ†æã‚’å®Ÿæ–½ï¼š

1. **Spotåˆ†æ**ï¼ˆ30ç§’ã”ã¨ï¼‰: ç¬é–“çš„ãªæ„Ÿæƒ…çŠ¶æ…‹
2. **Dailyåˆ†æ**ï¼ˆ1æ—¥åˆ†ï¼‰: ãã®æ—¥ã®ç´¯ç©åˆ†æ
3. **Weeklyåˆ†æ**ï¼ˆ1é€±é–“åˆ†ï¼‰: é€±æ¬¡ã®å°è±¡çš„ã‚¤ãƒ™ãƒ³ãƒˆæŠ½å‡º

ã—ã‹ã—ã€**å„åˆ†æã¯ç›¸äº’ã«ç‹¬ç«‹**ã—ã¦ãŠã‚Šã€ä»¥ä¸‹ã®å•é¡ŒãŒã‚ã‚‹ï¼š

### âŒ ç¾çŠ¶ã®èª²é¡Œ

#### 1. ã‚³ãƒ³ãƒ†ã‚¯ã‚¹ãƒˆã®æ–­çµ¶

```
Spot 1 (16:01) â†’ ç‹¬ç«‹åˆ†æ
Spot 2 (16:31) â†’ ç‹¬ç«‹åˆ†æï¼ˆSpot 1ã‚’çŸ¥ã‚‰ãªã„ï¼‰
Spot 3 (17:01) â†’ ç‹¬ç«‹åˆ†æï¼ˆSpot 1-2ã‚’çŸ¥ã‚‰ãªã„ï¼‰
```

**å•é¡Œ**:
- åŒã˜å‡ºæ¥äº‹ã®ç¶šããªã®ã«ã€æ–°ã—ã„å‡ºæ¥äº‹ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹
- "ã„ã¤ã‚‚ã®æ™‚é–“å¸¯ã®æ€’ã‚Š"ãªã®ã‹"æ–°ã—ã„å•é¡Œ"ãªã®ã‹åˆ¤æ–­ã§ããªã„

#### 2. è¨˜æ†¶ã®éåŠ¹ç‡æ€§

LLMã«1æ—¥åˆ†ã™ã¹ã¦ã®Spotã‚’æ¸¡ã™ã¨ï¼š
- 48 Spots Ã— å¹³å‡500 tokens = **24,000 tokens**
- ã‚³ã‚¹ãƒˆå¢—å¤§
- å‡¦ç†æ™‚é–“ã®å¢—å¤§
- é‡è¦ã§ãªã„æƒ…å ±ã‚‚å¹³ç­‰ã«æ‰±ã‚ã‚Œã‚‹

#### 3. äººé–“ã®è¨˜æ†¶ã¨ã®ä¹–é›¢

**äººé–“ã®è¨˜æ†¶**:
- âœ… é‡è¦ãªã“ã¨ã¯è¨˜æ†¶ã«æ®‹ã‚‹ï¼ˆæ„Ÿæƒ…ã‚’ä¼´ã†å‡ºæ¥äº‹ï¼‰
- âœ… äº›ç´°ãªã“ã¨ã¯å¿˜ã‚Œã‚‹ï¼ˆæ—¥å¸¸ã®ç¹°ã‚Šè¿”ã—ï¼‰
- âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡ºã™ã‚‹ï¼ˆ"ã„ã¤ã‚‚ã®è¡Œå‹•"ã‚’èªè­˜ï¼‰
- âœ… æ–‡è„ˆä¾å­˜ã§æ€ã„å‡ºã™ï¼ˆ"ã‚ã®æ™‚ã®ã‚ã‚Œ"ãŒé€šã˜ã‚‹ï¼‰

**ç¾åœ¨ã®LLMåˆ†æ**:
- âŒ ã™ã¹ã¦å¹³ç­‰ã«æ‰±ã†
- âŒ å‰ã®åˆ†æã‚’è¦šãˆã¦ã„ãªã„
- âŒ ãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜ãŒä¸ååˆ†
- âŒ æ–‡è„ˆãŒé€”åˆ‡ã‚Œã‚‹

---

## ç¾çŠ¶ã®åˆ¶ç´„

### æŠ€è¡“çš„åˆ¶ç´„

| é …ç›® | åˆ¶ç´„ | å½±éŸ¿ |
|------|------|------|
| LLMã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ | 200k tokensï¼ˆGPT-4oï¼‰ | ç´„1é€±é–“åˆ†ã®SpotãŒé™ç•Œ |
| APIæ–™é‡‘ | Input: $2.50/1M tokens | é•·æœŸãƒ‡ãƒ¼ã‚¿å‚ç…§ã§ã‚³ã‚¹ãƒˆå¢— |
| å‡¦ç†æ™‚é–“ | 1ãƒªã‚¯ã‚¨ã‚¹ãƒˆ5-10ç§’ | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ã®ä½ä¸‹ |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®¹é‡ | 48 Spots/æ—¥ Ã— 365æ—¥ | 17,520 records/å¹´/device |

### é‹ç”¨ä¸Šã®èª²é¡Œ

1. **Dailyåˆ†æã®é™ç•Œ**
   - å‰æ—¥ã®æƒ…å ±ãŒå‚ç…§ã•ã‚Œãªã„
   - ã€Œæ˜¨æ—¥ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã‚’æ¤œå‡ºã§ããªã„

2. **Weeklyåˆ†æã®é™ç•Œ**
   - é€±ã®å‰åŠã¨å¾ŒåŠã§æ–‡è„ˆãŒé€”åˆ‡ã‚Œã‚‹
   - å…ˆé€±ã¨ã®æ¯”è¼ƒãŒå›°é›£

3. **é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰ã®æ¬ å¦‚**
   - 1ãƒ¶æœˆå‰ã¨ã®æ¯”è¼ƒãŒã§ããªã„
   - å­£ç¯€å¤‰å‹•ã®æ¤œå‡ºãŒå›°é›£

---

## ç›®æŒ‡ã™ã¹ãç†æƒ³ã®å§¿

### äººé–“ã®ã‚ˆã†ãªè¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ§  äººé–“ã®å¿ƒç†ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼ã®è¨˜æ†¶            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  "ä»Šæ—¥ã‚‚16æ™‚ã”ã‚ã«æ¯è¦ªãŒã‚¤ãƒ©ã‚¤ãƒ©ã—ã¦ã¾ã™ã­" â”‚
â”‚   â†“                                         â”‚
â”‚  æ˜¨æ—¥ãƒ»å…ˆé€±ã‚‚åŒã˜æ™‚é–“å¸¯ã«ã‚¹ãƒˆãƒ¬ã‚¹ãŒé«˜ã‹ã£ãŸ â”‚
â”‚   â†“                                         â”‚
â”‚  ã§ã‚‚ã€2é€±é–“å‰ã‹ã‚‰å°‘ã—æ”¹å–„ã®å…†ã—ãŒã‚ã‚‹      â”‚
â”‚   â†“                                         â”‚
â”‚  1ãƒ¶æœˆå‰ã®ã€Œç‰¹ã«è¾›ã‹ã£ãŸæ—¥ã€ã¨æ¯”ã¹ã‚‹ã¨...   â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç†æƒ³çš„ãªåˆ†æãƒ•ãƒ­ãƒ¼

#### ä¾‹: 2026å¹´1æœˆ5æ—¥ 16:01ã®Spotåˆ†æ

**å…¥åŠ›ãƒ‡ãƒ¼ã‚¿**:
- éŸ³å£°: æ¯è¦ªã®å±è²¬ï¼ˆ"é£Ÿã¹ãªã„ã§ã£ã¦..."ï¼‰
- æ„Ÿæƒ…: Determination 25%, Distress 12%

**AIãŒå‚ç…§ã™ã¹ãè¨˜æ†¶**:

1. **ç›´è¿‘ã®è¨˜æ†¶**ï¼ˆæ˜¨æ—¥ï¼‰
   - "æ˜¨æ—¥ã‚‚16:00ã«åŒæ§˜ã®å±è²¬ï¼ˆDetermination 28%ï¼‰"

2. **çŸ­æœŸè¨˜æ†¶**ï¼ˆä»Šé€±ï¼‰
   - "ä»Šé€±ã¯æ¯æ—¥16-17æ™‚ã«Distresså¢—åŠ "
   - "ãƒ‘ã‚¿ãƒ¼ãƒ³: ãŠã‚„ã¤æ™‚é–“ã®èº¾"

3. **é•·æœŸè¨˜æ†¶**ï¼ˆå…ˆé€±ãƒ»å…ˆæœˆï¼‰
   - "å…ˆé€±æ¯”ã§Distress +10%"
   - "12æœˆä¸­æ—¬ã‹ã‚‰è‚²å…ç–²åŠ´ã®å…†å€™"

4. **å°è±¡çš„ãªå‡ºæ¥äº‹**ï¼ˆéå»30æ—¥ï¼‰
   - "12/28ã«æ¿€ã—ã„æ€’ã‚Šï¼ˆAnger 35%ï¼‰"
   - "1/3ã¯ç©ã‚„ã‹ï¼ˆCalmnesså„ªä½ï¼‰"

**åˆ†æçµæœ**:

> æœ¬æ—¥16:01ã®æ¯è¦ªã®å±è²¬ï¼ˆDetermination 25%ï¼‰ã¯ã€ä»Šé€±ç¶™ç¶šã—ã¦ã„ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¸€éƒ¨ã§ã™ã€‚å…ˆé€±æ¯”ã§ã‚„ã‚„ç©ã‚„ã‹ã«ãªã£ã¦ã„ã¾ã™ãŒï¼ˆå…ˆé€±28% â†’ ä»Šé€±å¹³å‡26%ï¼‰ã€12æœˆä¸­æ—¬ã‹ã‚‰ç¶šãè‚²å…ç–²åŠ´ã®å…†å€™ã¯ç¶™ç¶šã—ã¦ã„ã¾ã™ã€‚ãŸã ã—ã€1/3ã®ç©ã‚„ã‹ãªæ—¥ãŒã‚ã£ãŸã“ã¨ã‹ã‚‰ã€æ”¹å–„ã®å¯èƒ½æ€§ã‚‚è¦‹ãˆã¦ã„ã¾ã™ã€‚

---

## ææ¡ˆã™ã‚‹è§£æ±ºç­–

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: éšå±¤çš„è¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: Spot Analysisï¼ˆç¬é–“è¨˜æ†¶ï¼‰                  â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚  - 30ç§’ã”ã¨ã®ç”Ÿãƒ‡ãƒ¼ã‚¿                                â”‚
â”‚  - ã™ã¹ã¦ã®æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ï¼ˆ48æ„Ÿæƒ…ï¼‰                      â”‚
â”‚  - ç”Ÿã®ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³                          â”‚
â”‚  - é‡è¦åº¦ã‚¹ã‚³ã‚¢ï¼ˆæ–°è¦è¿½åŠ ï¼‰                          â”‚
â”‚                                                     â”‚
â”‚  ä¿å­˜: æ°¸ç¶šï¼ˆSupabase: spot_featuresï¼‰              â”‚
â”‚  å‚ç…§é »åº¦: ä½                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“ æŠ½å‡ºãƒ»è¦ç´„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: Daily Summaryï¼ˆçŸ­æœŸè¨˜æ†¶ï¼‰                 â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚  - 1æ—¥ã®é‡è¦ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆTop 5-10ï¼‰                     â”‚
â”‚  - æ„Ÿæƒ…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®çµ±è¨ˆ                                â”‚
â”‚  - LLMç”Ÿæˆã‚µãƒãƒªãƒ¼                                   â”‚
â”‚                                                     â”‚
â”‚  ä¿å­˜: æ°¸ç¶šï¼ˆSupabase: daily_summariesï¼‰            â”‚
â”‚  å‚ç…§é »åº¦: ä¸­                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“ ãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Weekly/Monthly Patternï¼ˆé•·æœŸè¨˜æ†¶ï¼‰       â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚  - ç¹°ã‚Šè¿”ã—ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ"æ¯æ—¥16æ™‚ã«..."ï¼‰              â”‚
â”‚  - ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆ"å…ˆé€±æ¯” +10%"ï¼‰                         â”‚
â”‚  - ä»£è¡¨çš„ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå„ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å…¸å‹ä¾‹ï¼‰              â”‚
â”‚                                                     â”‚
â”‚  ä¿å­˜: æ°¸ç¶šï¼ˆSupabase: pattern_summariesï¼‰          â”‚
â”‚  å‚ç…§é »åº¦: é«˜                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–¹å¼1: é‡è¦åº¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚° + é¸æŠçš„è¨˜æ†¶

#### æ¦‚è¦
å„Spotã«ã€Œé‡è¦åº¦ã‚¹ã‚³ã‚¢ã€ã‚’ä»˜ä¸ã—ã€Dailyåˆ†ææ™‚ã«é‡è¦ãªSpotã®ã¿å‚ç…§

#### é‡è¦åº¦ã‚¹ã‚³ã‚¢ã®è¨ˆç®—åŸºæº–

```python
def calculate_importance_score(spot):
    """
    Spotã®é‡è¦åº¦ã‚’0-100ã§è¨ˆç®—
    äººé–“ã®è¨˜æ†¶ã«æ®‹ã‚Šã‚„ã™ã„è¦ç´ ã‚’é‡è¦–
    """
    score = 0

    # 1. æ„Ÿæƒ…ã®å¼·ã•ï¼ˆæ¥µç«¯ãªæ„Ÿæƒ…ã¯è¨˜æ†¶ã«æ®‹ã‚‹ï¼‰
    max_emotion_score = max(spot['emotions'].values())
    if max_emotion_score > 0.3:  # 30%ä»¥ä¸Š
        score += max_emotion_score * 20  # æœ€å¤§6ç‚¹

    # 2. æ„Ÿæƒ…ã®å¤‰åŒ–é‡ï¼ˆå‰å›ã‹ã‚‰ã®æ€¥æ¿€ãªå¤‰åŒ–ï¼‰
    prev_spot = get_previous_spot(spot)
    if prev_spot:
        emotion_change = calculate_emotion_distance(spot, prev_spot)
        score += emotion_change * 10  # æœ€å¤§5ç‚¹

    # 3. ãƒã‚¬ãƒ†ã‚£ãƒ–æ„Ÿæƒ…ã®é‡ã¿ä»˜ã‘
    negative_emotions = {
        'Anger': 3.0,      # æ€’ã‚Šã¯å¼·ãè¨˜æ†¶ã«æ®‹ã‚‹
        'Distress': 2.5,
        'Anxiety': 2.0,
        'Fear': 2.5,
        'Sadness': 2.0
    }
    for emotion, weight in negative_emotions.items():
        score += spot['emotions'].get(emotion, 0) * weight * 10

    # 4. ãƒã‚¸ãƒ†ã‚£ãƒ–æ„Ÿæƒ…ã®é‡ã¿ä»˜ã‘ï¼ˆã‚„ã‚„ä½ã‚ï¼‰
    positive_emotions = {
        'Joy': 1.5,
        'Excitement': 1.5,
        'Love': 2.0
    }
    for emotion, weight in positive_emotions.items():
        score += spot['emotions'].get(emotion, 0) * weight * 10

    # 5. Vocal Burstï¼ˆç¬‘ã„å£°ãƒ»æ³£ãå£°ã¯è¨˜æ†¶ã«æ®‹ã‚‹ï¼‰
    if spot.get('vocal_burst_count', 0) > 0:
        score += 15

    # 6. ç™ºè©±ã®é•·ã•ï¼ˆé‡è¦ãªä¼šè©±ã¯é•·ã„ï¼‰
    if spot.get('transcription_length', 0) > 50:  # 50æ–‡å­—ä»¥ä¸Š
        score += 5

    # 7. æ™‚é–“å¸¯ã®ç‰¹ç•°æ€§ï¼ˆæ·±å¤œãƒ»æ—©æœã¯è¨˜æ†¶ã«æ®‹ã‚‹ï¼‰
    hour = spot['recorded_at'].hour
    if hour < 6 or hour > 23:
        score += 10

    return min(score, 100)  # æœ€å¤§100ç‚¹
```

#### ä½¿ç”¨ä¾‹

```python
# Dailyåˆ†ææ™‚
def daily_analysis(device_id, local_date):
    # ã™ã¹ã¦ã®Spotå–å¾—
    spots = get_all_spots(device_id, local_date)

    # é‡è¦åº¦ã§ã‚½ãƒ¼ãƒˆ
    spots_sorted = sorted(
        spots,
        key=lambda s: s['importance_score'],
        reverse=True
    )

    # Top 10ã®ã¿LLMã«æ¸¡ã™
    important_spots = spots_sorted[:10]

    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
    prompt = f"""
    {local_date}ã®é‡è¦ãªå ´é¢ï¼ˆé‡è¦åº¦é †ï¼‰:

    {format_spots_for_llm(important_spots)}

    ã“ã®æ—¥ã®å¿ƒç†çŠ¶æ…‹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
    """
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… å®Ÿè£…ãŒç°¡å˜ï¼ˆspot_featuresãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚«ãƒ©ãƒ è¿½åŠ ã®ã¿ï¼‰
- âœ… ãƒˆãƒ¼ã‚¯ãƒ³ç¯€ç´„ï¼ˆé‡è¦ãªSpotã®ã¿ï¼‰
- âœ… äººé–“ã®è¨˜æ†¶ã«è¿‘ã„é¸æŠ

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âš ï¸ ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°åŸºæº–ã®èª¿æ•´ãŒå¿…è¦
- âš ï¸ é‡è¦åº¦ã®ä½ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹é€ƒã•ã‚Œã‚‹å¯èƒ½æ€§

---

### æ–¹å¼2: éšå±¤çš„è¦ç´„ + å‰æ—¥å‚ç…§

#### æ¦‚è¦
Dailyåˆ†ææ™‚ã«ã€Œå‰æ—¥ã®Daily Summaryã€ã‚’å‚ç…§ã—ã€ç¶™ç¶šæ€§ã‚’æŒãŸã›ã‚‹

#### ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```json
// Daily Summaryï¼ˆdaily_summaries ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
{
  "device_id": "uuid",
  "local_date": "2026-01-05",
  "key_events": [
    {
      "time": "16:01",
      "summary": "æ¯è¦ªãŒ5æ­³ç”·å…ã‚’å±è²¬ï¼ˆãŠã‚„ã¤æ™‚ã®èº¾ï¼‰",
      "emotions": {
        "Determination": 0.25,
        "Distress": 0.12
      },
      "importance": 8.5,
      "spot_ids": ["spot-uuid-1", "spot-uuid-2"]
    }
  ],
  "emotional_statistics": {
    "avg_distress": 0.15,
    "peak_anger_time": "16:30",
    "calm_periods": ["10:00-12:00", "20:00-21:00"]
  },
  "overall_summary": "è‚²å…ç–²åŠ´ã®å…†å€™ã€ç‰¹ã«16-17æ™‚ã«ã‚¹ãƒˆãƒ¬ã‚¹é›†ä¸­",
  "notable_patterns": [
    "16æ™‚å°ã®Distressé »å‡ºï¼ˆ3å›ï¼‰",
    "å¤•é£Ÿå‰ã®æ™‚é–“å¸¯ã«å±è²¬å¤šã„"
  ]
}
```

#### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ

```python
def daily_analysis_with_context(device_id, local_date):
    # å‰æ—¥ã®Daily Summaryå–å¾—
    yesterday = local_date - timedelta(days=1)
    previous_summary = get_daily_summary(device_id, yesterday)

    # ä»Šé€±ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆé€²è¡Œä¸­ï¼‰
    week_start = get_week_start(local_date)
    week_patterns = get_week_patterns(device_id, week_start)

    # æœ¬æ—¥ã®é‡è¦Spot
    today_spots = get_important_spots(device_id, local_date, limit=10)

    prompt = f"""
    # å‰æ—¥ï¼ˆ{yesterday}ï¼‰ã®çŠ¶æ³
    {previous_summary['overall_summary']}

    ä¸»ãªå‡ºæ¥äº‹:
    {format_key_events(previous_summary['key_events'])}

    # ä»Šé€±ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ{week_start}ã€œï¼‰
    {format_patterns(week_patterns)}

    # æœ¬æ—¥ï¼ˆ{local_date}ï¼‰ã®Spotåˆ†æçµæœ
    {format_spots(today_spots)}

    ---

    ## åˆ†æã‚¿ã‚¹ã‚¯

    å‰æ—¥ãƒ»ä»Šé€±ã®æ–‡è„ˆã‚’è¸ã¾ãˆã€æœ¬æ—¥ã®å¿ƒç†çŠ¶æ…‹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

    ç‰¹ã«ä»¥ä¸‹ã®ç‚¹ã«æ³¨ç›®ï¼š
    1. å‰æ—¥ã‹ã‚‰ã®ç¶™ç¶šæ€§ï¼ˆåŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼Ÿæ–°ã—ã„å•é¡Œï¼Ÿï¼‰
    2. ä»Šé€±ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã®ä¸€è‡´/ç›¸é•
    3. æ”¹å–„ã®å…†å€™ã¾ãŸã¯æ‚ªåŒ–ã®å…†å€™
    4. æ³¨ç›®ã™ã¹ãå¤‰åŒ–
    """
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… å‰æ—¥ã¨ã®ç¹‹ãŒã‚ŠãŒæ˜ç¢º
- âœ… "æ˜¨æ—¥ã¨åŒã˜"ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºå¯èƒ½
- âœ… å¤‰åŒ–ã®æ¤œå‡ºãŒå®¹æ˜“

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âš ï¸ 1é€±é–“ä»¥ä¸Šå‰ã®æƒ…å ±ã¯å‚ç…§ã•ã‚Œãªã„
- âš ï¸ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆãŒè¤‡é›‘

---

### æ–¹å¼3: ãƒ™ã‚¯ãƒˆãƒ«DB + æ„å‘³æ¤œç´¢ï¼ˆå°†æ¥å¯¾å¿œï¼‰

#### æ¦‚è¦
ã™ã¹ã¦ã®Spot/Dailyåˆ†æã‚’åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã—ã€æ„å‘³çš„ã«é–¢é€£ã™ã‚‹éå»è¨˜æ†¶ã‚’æ¤œç´¢

#### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL (Supabase)              â”‚
â”‚  + pgvector extension               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  CREATE TABLE long_term_memories (  â”‚
â”‚    id UUID,                         â”‚
â”‚    device_id UUID,                  â”‚
â”‚    event_date DATE,                 â”‚
â”‚    event_summary TEXT,              â”‚
â”‚    embedding VECTOR(1536),          â”‚
â”‚    importance_score FLOAT,          â”‚
â”‚    tags TEXT[]                      â”‚
â”‚  );                                 â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```python
# 1. åŸ‹ã‚è¾¼ã¿ç”Ÿæˆï¼ˆOpenAI Embeddingsï¼‰
def embed_memory(memory_text):
    response = openai.embeddings.create(
        model="text-embedding-3-small",
        input=memory_text
    )
    return response.data[0].embedding

# 2. é¡ä¼¼è¨˜æ†¶æ¤œç´¢ï¼ˆpgvectorï¼‰
def retrieve_similar_memories(current_spot, limit=5):
    current_embedding = embed_memory(current_spot['summary'])

    query = """
        SELECT
            event_date,
            event_summary,
            importance_score,
            1 - (embedding <=> %s::vector) as similarity
        FROM long_term_memories
        WHERE device_id = %s
        ORDER BY embedding <=> %s::vector
        LIMIT %s
    """

    results = execute_query(query, [
        current_embedding,
        current_spot['device_id'],
        current_embedding,
        limit
    ])

    return results

# 3. Dailyåˆ†ææ™‚ã«ä½¿ç”¨
def daily_analysis_with_semantic_search(device_id, local_date):
    today_spots = get_important_spots(device_id, local_date)

    # ä»Šæ—¥ã®é‡è¦Spotã«é¡ä¼¼ã™ã‚‹éå»è¨˜æ†¶ã‚’æ¤œç´¢
    relevant_memories = []
    for spot in today_spots[:3]:  # Top 3
        similar = retrieve_similar_memories(spot, limit=3)
        relevant_memories.extend(similar)

    # é‡è¤‡å‰Šé™¤ãƒ»é‡è¦åº¦é †ã‚½ãƒ¼ãƒˆ
    unique_memories = deduplicate(relevant_memories)
    sorted_memories = sorted(
        unique_memories,
        key=lambda m: m['importance_score'],
        reverse=True
    )[:5]

    prompt = f"""
    # æ„å‘³çš„ã«é–¢é€£ã™ã‚‹éå»ã®è¨˜æ†¶
    {format_memories(sorted_memories)}

    # æœ¬æ—¥ã®Spotåˆ†æ
    {format_spots(today_spots)}

    éå»ã®é¡ä¼¼å ´é¢ã‚’è¸ã¾ãˆã€æœ¬æ—¥ã®çŠ¶æ³ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
    """
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… æ™‚ç³»åˆ—ã«ä¾å­˜ã—ãªã„ï¼ˆ1é€±é–“å‰ã§ã‚‚1ãƒ¶æœˆå‰ã§ã‚‚é–¢é€£ã‚ã‚Œã°å–å¾—ï¼‰
- âœ… "ã‚ã®æ™‚ã¨ä¼¼ã¦ã„ã‚‹"ã‚’è‡ªå‹•æ¤œå‡º
- âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜ãŒé«˜åº¦

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âš ï¸ åŸ‹ã‚è¾¼ã¿ç”Ÿæˆã‚³ã‚¹ãƒˆï¼ˆ$0.02/1M tokensï¼‰
- âš ï¸ pgvectoré‹ç”¨ãŒå¿…è¦
- âš ï¸ å®Ÿè£…è¤‡é›‘åº¦ãŒé«˜ã„

---

### æ–¹å¼4: è¨˜æ†¶ã®æ®µéšçš„åœ§ç¸®ï¼ˆæ¨å¥¨ï¼‰

#### æ¦‚è¦
æ™‚é–“çµŒéã¨ã¨ã‚‚ã«è¨˜æ†¶ã‚’åœ§ç¸®ã—ã€é‡è¦ãªæƒ…å ±ã®ã¿ä¿æŒï¼ˆäººé–“ã®å¿˜å´æ›²ç·šã«æœ€ã‚‚è¿‘ã„ï¼‰

#### è¨˜æ†¶ã®åœ§ç¸®ãƒ¬ãƒ™ãƒ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 0: Spotï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ï¼‰              â”‚
â”‚  ä¿å­˜: æ°¸ç¶š                             â”‚
â”‚  å‚ç…§: ã»ã¼ãªã—ï¼ˆDailyåˆ†ææ™‚ã®ã¿ï¼‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Level 1: Daily Summaryï¼ˆ1æ—¥å¾Œï¼‰       â”‚
â”‚  - é‡è¦ã‚¤ãƒ™ãƒ³ãƒˆ5-10å€‹                   â”‚
â”‚  - æ„Ÿæƒ…çµ±è¨ˆ                             â”‚
â”‚  - ã‚µãƒãƒªãƒ¼ï¼ˆ200-300æ–‡å­—ï¼‰              â”‚
â”‚  å‚ç…§: é«˜é »åº¦ï¼ˆç¿Œæ—¥ã®Dailyåˆ†æï¼‰        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Level 2: Weekly Patternï¼ˆ1é€±é–“å¾Œï¼‰    â”‚
â”‚  - ç¹°ã‚Šè¿”ã—ãƒ‘ã‚¿ãƒ¼ãƒ³2-3å€‹                â”‚
â”‚  - ä»£è¡¨çš„ã‚¤ãƒ™ãƒ³ãƒˆ1-2å€‹                  â”‚
â”‚  - ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆ100æ–‡å­—ï¼‰                  â”‚
â”‚  å‚ç…§: ä¸­é »åº¦ï¼ˆæ¬¡é€±ã®Dailyåˆ†æï¼‰        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Level 3: Monthly Trendï¼ˆ1ãƒ¶æœˆå¾Œï¼‰     â”‚
â”‚  - å…¨ä½“ãƒˆãƒ¬ãƒ³ãƒ‰1ã¤                      â”‚
â”‚  - é‡è¦ãªå¤‰åŒ–ç‚¹1-2å€‹                    â”‚
â”‚  - ã‚µãƒãƒªãƒ¼ï¼ˆ50æ–‡å­—ï¼‰                   â”‚
â”‚  å‚ç…§: ä½é »åº¦ï¼ˆæœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆï¼‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Dailyåˆ†ææ™‚ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹æˆ

```python
def get_context_for_daily_analysis(device_id, local_date):
    return {
        # 1. ç›´è¿‘ï¼ˆè©³ç´°ï¼‰
        "yesterday": get_daily_summary(device_id, local_date - 1),

        # 2. çŸ­æœŸï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
        "this_week": get_weekly_pattern(
            device_id,
            get_week_start(local_date)
        ),

        # 3. ä¸­æœŸï¼ˆãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰
        "last_week": get_weekly_pattern(
            device_id,
            get_week_start(local_date) - timedelta(weeks=1)
        ),

        # 4. é•·æœŸï¼ˆå¤‰åŒ–ç‚¹ï¼‰
        "this_month": get_monthly_trend(
            device_id,
            local_date.replace(day=1)
        ),

        # 5. å°è±¡çš„ãªå‡ºæ¥äº‹ï¼ˆéå»30æ—¥ã‹ã‚‰é‡è¦åº¦Top 3ï¼‰
        "memorable_events": get_top_events(
            device_id,
            start_date=local_date - timedelta(days=30),
            end_date=local_date,
            limit=3
        )
    }
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… äººé–“ã®è¨˜æ†¶ã«æœ€ã‚‚è¿‘ã„
- âœ… é•·æœŸçš„ã«ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«
- âœ… ãƒˆãƒ¼ã‚¯ãƒ³åŠ¹ç‡çš„
- âœ… æ®µéšçš„ã«å®Ÿè£…å¯èƒ½

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âš ï¸ åœ§ç¸®ãƒ­ã‚¸ãƒƒã‚¯ã®è¨­è¨ˆãŒå¿…è¦
- âš ï¸ åœ§ç¸®æ™‚ã«æƒ…å ±æå¤±ã®å¯èƒ½æ€§

---

## å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 1: åŸºç¤æ©Ÿèƒ½ï¼ˆ1-2é€±é–“ï¼‰

**ç›®æ¨™**: å‰æ—¥ã®Daily Summaryã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

#### ã‚¿ã‚¹ã‚¯

- [ ] `spot_features`ãƒ†ãƒ¼ãƒ–ãƒ«ã«`importance_score`ã‚«ãƒ©ãƒ è¿½åŠ 
- [ ] é‡è¦åº¦ã‚¹ã‚³ã‚¢è¨ˆç®—é–¢æ•°ã®å®Ÿè£…
- [ ] Dailyåˆ†ææ™‚ã«å‰æ—¥ã®Daily Summaryã‚’å‚ç…§ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 
- [ ] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿®æ­£ï¼ˆå‰æ—¥æƒ…å ±ã‚’å«ã‚ã‚‹ï¼‰

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´

```sql
-- spot_features ãƒ†ãƒ¼ãƒ–ãƒ«
ALTER TABLE spot_features
ADD COLUMN importance_score FLOAT DEFAULT 0;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ ï¼ˆé‡è¦åº¦é †ã‚½ãƒ¼ãƒˆç”¨ï¼‰
CREATE INDEX idx_spot_features_importance
ON spot_features(device_id, local_date, importance_score DESC);
```

#### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

- âœ… "æ˜¨æ—¥ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³"ã®æ¤œå‡º
- âœ… Dailyåˆ†æã®æ–‡è„ˆãŒç¹‹ãŒã‚‹
- âœ… ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã®å‰Šæ¸›ï¼ˆé‡è¦ãªSpotã®ã¿å‚ç…§ï¼‰

---

### Phase 2: é€±æ¬¡ãƒ‘ã‚¿ãƒ¼ãƒ³æŠ½å‡ºï¼ˆ2-3é€±é–“ï¼‰

**ç›®æ¨™**: 1é€±é–“åˆ†ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡ºãƒ»ä¿å­˜

#### ã‚¿ã‚¹ã‚¯

- [ ] `weekly_patterns`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] Weekly PatternæŠ½å‡ºãƒãƒƒãƒå‡¦ç†å®Ÿè£…
- [ ] Dailyåˆ†ææ™‚ã«ä»Šé€±ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‚ç…§
- [ ] Weekly Summaryã®è‡ªå‹•ç”Ÿæˆ

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

```sql
CREATE TABLE weekly_patterns (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    device_id UUID NOT NULL,
    week_start DATE NOT NULL,
    week_end DATE NOT NULL,

    -- ãƒ‘ã‚¿ãƒ¼ãƒ³æƒ…å ±
    recurring_patterns JSONB NOT NULL,
    representative_events JSONB NOT NULL,
    emotional_trends JSONB NOT NULL,

    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    total_spots INT,
    analyzed_days INT,
    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(device_id, week_start)
);

CREATE INDEX idx_weekly_patterns_device
ON weekly_patterns(device_id, week_start DESC);
```

#### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

- âœ… "ä»Šé€±ã¯ãšã£ã¨..."ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡º
- âœ… é€±å†…ã§ã®å¤‰åŒ–ã®è¿½è·¡
- âœ… Weekly Summaryã®ç²¾åº¦å‘ä¸Š

---

### Phase 3: é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æï¼ˆ1ãƒ¶æœˆï¼‰

**ç›®æ¨™**: æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰ã®æŠ½å‡ºã¨é•·æœŸå¤‰åŒ–ã®æ¤œå‡º

#### ã‚¿ã‚¹ã‚¯

- [ ] `monthly_trends`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] Monthly TrendæŠ½å‡ºãƒãƒƒãƒå‡¦ç†å®Ÿè£…
- [ ] é•·æœŸå¤‰åŒ–ã®æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
- [ ] Monthly Reportã®è‡ªå‹•ç”Ÿæˆ

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

```sql
CREATE TABLE monthly_trends (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    device_id UUID NOT NULL,
    month_start DATE NOT NULL,
    month_end DATE NOT NULL,

    -- ãƒˆãƒ¬ãƒ³ãƒ‰æƒ…å ±
    overall_trend TEXT NOT NULL,
    significant_changes JSONB NOT NULL,
    comparison_vs_previous_month JSONB,

    -- çµ±è¨ˆ
    total_spots INT,
    avg_daily_distress FLOAT,
    peak_stress_periods JSONB,

    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(device_id, month_start)
);
```

#### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

- âœ… é•·æœŸçš„ãªæ”¹å–„/æ‚ªåŒ–ã®æ¤œå‡º
- âœ… å­£ç¯€å¤‰å‹•ã®æŠŠæ¡
- âœ… Monthly Reportã®æä¾›

---

### Phase 4: æ„å‘³æ¤œç´¢ï¼ˆå°†æ¥å¯¾å¿œãƒ»3ãƒ¶æœˆä»¥é™ï¼‰

**ç›®æ¨™**: ãƒ™ã‚¯ãƒˆãƒ«DBã«ã‚ˆã‚‹æ„å‘³çš„ãªè¨˜æ†¶æƒ³èµ·

#### ã‚¿ã‚¹ã‚¯

- [ ] pgvector extensionã®æœ‰åŠ¹åŒ–ï¼ˆSupabaseï¼‰
- [ ] `long_term_memories`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] OpenAI Embeddingsé€£æº
- [ ] é¡ä¼¼è¨˜æ†¶æ¤œç´¢APIå®Ÿè£…
- [ ] Dailyåˆ†æã¸ã®çµ±åˆ

#### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

- âœ… "ã‚ã®æ™‚ã¨ä¼¼ã¦ã„ã‚‹"ã®è‡ªå‹•æ¤œå‡º
- âœ… æ™‚ç³»åˆ—ã«ä¾å­˜ã—ãªã„è¨˜æ†¶æƒ³èµ·
- âœ… é«˜åº¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜

---

## æŠ€è¡“çš„è©³ç´°

### é‡è¦åº¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã®è©³ç´°

#### 1. æ„Ÿæƒ…ã®å¼·ã•

```python
def emotion_intensity_score(emotions):
    """æ„Ÿæƒ…ã®å¼·ã•ã‚’è©•ä¾¡ï¼ˆ0-20ç‚¹ï¼‰"""
    max_emotion = max(emotions.values())

    if max_emotion > 0.5:
        return 20  # éå¸¸ã«å¼·ã„
    elif max_emotion > 0.3:
        return 15  # å¼·ã„
    elif max_emotion > 0.2:
        return 10  # ä¸­ç¨‹åº¦
    else:
        return 5   # å¼±ã„
```

#### 2. æ„Ÿæƒ…ã®å¤‰åŒ–é‡

```python
def emotion_change_score(current_spot, previous_spot):
    """å‰å›ã‹ã‚‰ã®æ„Ÿæƒ…å¤‰åŒ–ï¼ˆ0-15ç‚¹ï¼‰"""
    if not previous_spot:
        return 0

    # ãƒ™ã‚¯ãƒˆãƒ«è·é›¢ï¼ˆã‚³ã‚µã‚¤ãƒ³è·é›¢ï¼‰
    current_vector = [current_spot['emotions'][e] for e in EMOTION_NAMES]
    prev_vector = [previous_spot['emotions'][e] for e in EMOTION_NAMES]

    distance = cosine_distance(current_vector, prev_vector)

    # è·é›¢ã‚’0-15ç‚¹ã«ã‚¹ã‚±ãƒ¼ãƒ«
    return min(distance * 30, 15)
```

#### 3. ãƒã‚¬ãƒ†ã‚£ãƒ–/ãƒã‚¸ãƒ†ã‚£ãƒ–æ„Ÿæƒ…ã®é‡ã¿ä»˜ã‘

```python
EMOTION_WEIGHTS = {
    # ãƒã‚¬ãƒ†ã‚£ãƒ–ï¼ˆé‡ã‚ï¼‰
    'Anger': 3.0,
    'Distress': 2.5,
    'Anxiety': 2.5,
    'Fear': 2.5,
    'Sadness': 2.0,
    'Disgust': 2.0,
    'Contempt': 2.0,

    # ãƒã‚¸ãƒ†ã‚£ãƒ–ï¼ˆã‚„ã‚„è»½ã‚ï¼‰
    'Joy': 1.5,
    'Excitement': 1.5,
    'Love': 2.0,
    'Admiration': 1.5,

    # ä¸­ç«‹ï¼ˆè»½ã‚ï¼‰
    'Calmness': 0.5,
    'Concentration': 0.5
}

def weighted_emotion_score(emotions):
    """é‡ã¿ä»˜ã‘æ„Ÿæƒ…ã‚¹ã‚³ã‚¢ï¼ˆ0-40ç‚¹ï¼‰"""
    score = 0
    for emotion, value in emotions.items():
        weight = EMOTION_WEIGHTS.get(emotion, 1.0)
        score += value * weight * 10
    return min(score, 40)
```

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

#### 1. æ§‹é€ åŒ–ã•ã‚ŒãŸæƒ…å ±æç¤º

```python
def format_context_for_llm(context):
    """LLMã«æ¸¡ã™ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’Markdownå½¢å¼ã§æ•´å½¢"""

    prompt = f"""
# åˆ†æã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

## å‰æ—¥ï¼ˆ{context['yesterday']['date']}ï¼‰
{context['yesterday']['overall_summary']}

### ä¸»ãªå‡ºæ¥äº‹
{format_key_events(context['yesterday']['key_events'])}

## ä»Šé€±ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ{context['this_week']['week_range']}ï¼‰
{format_patterns(context['this_week']['patterns'])}

## æœ¬æ—¥ã®Spotåˆ†æï¼ˆ{context['today']['date']}ï¼‰

### é‡è¦åº¦Top 10
{format_spots(context['today']['spots'])}

---

## åˆ†æã‚¿ã‚¹ã‚¯

ä¸Šè¨˜ã®æ–‡è„ˆã‚’è¸ã¾ãˆã€æœ¬æ—¥ã®å¿ƒç†çŠ¶æ…‹ã‚’200-300æ–‡å­—ã§åˆ†æã—ã¦ãã ã•ã„ã€‚

ç‰¹ã«ä»¥ä¸‹ã«æ³¨ç›®ï¼š
1. å‰æ—¥ã‹ã‚‰ã®ç¶™ç¶šæ€§ï¼ˆâœ…åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ / âš ï¸æ–°ã—ã„å•é¡Œï¼‰
2. ä»Šé€±ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã®ä¸€è‡´åº¦
3. æ”¹å–„ã¾ãŸã¯æ‚ªåŒ–ã®å…†å€™
4. ç‰¹ç­†ã™ã¹ãå¤‰åŒ–

## å‡ºåŠ›å½¢å¼

JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
```json
{{
  "overall_summary": "æœ¬æ—¥ã®ç·åˆè©•ä¾¡ï¼ˆ200-300æ–‡å­—ï¼‰",
  "continuity_from_yesterday": "ç¶™ç¶š | æ–°è¦",
  "pattern_match": "ä¸€è‡´ | ç›¸é•",
  "trend": "æ”¹å–„ | æ‚ªåŒ– | ç¶­æŒ",
  "notable_changes": ["å¤‰åŒ–1", "å¤‰åŒ–2"]
}}
```
"""
    return prompt
```

#### 2. Few-shot Examples

```python
# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã‚µãƒ³ãƒ—ãƒ«åˆ†æã‚’å«ã‚ã‚‹
EXAMPLE_ANALYSIS = """
ã€åˆ†æä¾‹ã€‘

å…¥åŠ›:
- å‰æ—¥: 16æ™‚å°ã«Distressé«˜ã‚ï¼ˆ3å›ï¼‰
- ä»Šé€±: æ¯æ—¥16-17æ™‚ã«ã‚¹ãƒˆãƒ¬ã‚¹é›†ä¸­
- æœ¬æ—¥: 16:01ã«å±è²¬ï¼ˆDetermination 25%ï¼‰

å‡ºåŠ›:
{
  "overall_summary": "æœ¬æ—¥16:01ã®æ¯è¦ªã®å±è²¬ã¯ã€ä»Šé€±ç¶™ç¶šã—ã¦ã„ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¸€éƒ¨ã§ã™ã€‚å‰æ—¥ã¨åŒæ§˜ã®æ™‚é–“å¸¯ãƒ»å†…å®¹ã§ã‚ã‚Šã€è‚²å…ç–²åŠ´ãŒç¶™ç¶šã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºå”†ã—ã¾ã™ã€‚ãŸã ã—ã€å¼·åº¦ã¯ã‚„ã‚„ç©ã‚„ã‹ï¼ˆå‰æ—¥28% â†’ æœ¬æ—¥25%ï¼‰ã§ã‚ã‚Šã€å¾®æ”¹å–„ã®å…†ã—ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚",
  "continuity_from_yesterday": "ç¶™ç¶š",
  "pattern_match": "ä¸€è‡´",
  "trend": "å¾®æ”¹å–„",
  "notable_changes": ["å±è²¬ã®å¼·åº¦ãŒã‚„ã‚„ä½ä¸‹"]
}
"""
```

---

## å‚è€ƒè³‡æ–™

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [README.md](./README.md) - ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®æ§‹æˆ
- [PROCESSING_ARCHITECTURE.md](./PROCESSING_ARCHITECTURE.md) - ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ•ãƒ­ãƒ¼
- [SPOT_AND_DAILY_ANALYSIS_GUIDE.md](./SPOT_AND_DAILY_ANALYSIS_GUIDE.md) - ç¾åœ¨ã®åˆ†æä»•æ§˜

### æŠ€è¡“å‚è€ƒ

#### LLMã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†

- [Anthropic: Context Windows](https://docs.anthropic.com/claude/docs/context-windows)
- [OpenAI: Embeddings](https://platform.openai.com/docs/guides/embeddings)

#### ãƒ™ã‚¯ãƒˆãƒ«DB

- [pgvector Documentation](https://github.com/pgvector/pgvector)
- [Supabase Vector Columns](https://supabase.com/docs/guides/ai/vector-columns)

#### è¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ

- [LangChain Memory](https://python.langchain.com/docs/modules/memory/)
- [MemGPT: Memory Management for LLMs](https://memgpt.ai/)

### å­¦è¡“çš„èƒŒæ™¯

#### äººé–“ã®è¨˜æ†¶ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

- **ã‚¨ãƒ“ãƒ³ã‚°ãƒã‚¦ã‚¹ã®å¿˜å´æ›²ç·š**: æ™‚é–“çµŒéã«ã‚ˆã‚‹è¨˜æ†¶ã®æ¸›è¡°
- **ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ¡ãƒ¢ãƒª**: çŸ­æœŸè¨˜æ†¶ã®å®¹é‡åˆ¶é™ï¼ˆ7Â±2ãƒãƒ£ãƒ³ã‚¯ï¼‰
- **ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰è¨˜æ†¶ vs æ„å‘³è¨˜æ†¶**: å…·ä½“çš„å‡ºæ¥äº‹ vs æŠ½è±¡çš„çŸ¥è­˜

#### æ„Ÿæƒ…ã¨è¨˜æ†¶

- æ„Ÿæƒ…ã‚’ä¼´ã†å‡ºæ¥äº‹ã¯è¨˜æ†¶ã«æ®‹ã‚Šã‚„ã™ã„
- ãƒã‚¬ãƒ†ã‚£ãƒ–æ„Ÿæƒ…ã¯ãƒã‚¸ãƒ†ã‚£ãƒ–ã‚ˆã‚Šå¼·ãè¨˜æ†¶ã•ã‚Œã‚‹
- ç¹°ã‚Šè¿”ã—ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯æ„å‘³è¨˜æ†¶ã¨ã—ã¦æŠ½è±¡åŒ–ã•ã‚Œã‚‹

---

## ã¾ã¨ã‚

### çŸ­æœŸç›®æ¨™ï¼ˆ1-2ãƒ¶æœˆï¼‰

1. âœ… é‡è¦åº¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã®å®Ÿè£…
2. âœ… å‰æ—¥Daily Summaryã®å‚ç…§
3. âœ… Weekly PatternæŠ½å‡º

### ä¸­æœŸç›®æ¨™ï¼ˆ3-6ãƒ¶æœˆï¼‰

1. âœ… Monthly Trendåˆ†æ
2. âœ… é•·æœŸå¤‰åŒ–ã®è‡ªå‹•æ¤œå‡º
3. âœ… æ®µéšçš„è¨˜æ†¶åœ§ç¸®ã‚·ã‚¹ãƒ†ãƒ 

### é•·æœŸç›®æ¨™ï¼ˆ6ãƒ¶æœˆä»¥é™ï¼‰

1. âœ… ãƒ™ã‚¯ãƒˆãƒ«DBã«ã‚ˆã‚‹æ„å‘³æ¤œç´¢
2. âœ… é«˜åº¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜
3. âœ… äºˆæ¸¬çš„ãªåˆ†æï¼ˆ"ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒç¶šãã¨..."ï¼‰

---

**æœ€çµ‚æ›´æ–°**: 2026-01-09
**ä½œæˆè€…**: Claude Code
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸ”œ å®Ÿè£…å‰ï¼ˆè¨ˆç”»æ®µéšï¼‰
